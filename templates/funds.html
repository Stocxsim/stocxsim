{% extends "base.html" %}
{% block title %}Funds | Stocxsim{% endblock %}

{% block css %}
<link rel="stylesheet" href="/static/css/funds.css">
<style>
    .fund-tabs {
        font-weight: 600;
        cursor: pointer;
    }

    .fund-tab {
        color: #6b7280;
        padding-bottom: 6px;
    }

    .fund-tab.active {
        color: #04b488;
        border-bottom: 3px solid #04b488;
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="font-family: verdana; margin-top: 50px; margin-bottom: 50px;">
    <div class="row g-4">

        <!-- LEFT -->
        <div class="col-md-7">
            <div class="card p-4 text-center">
                <h6 class="text-muted">Stocks balance</h6>
                <h2 style=" color: #374151;">₹{{ user.balance }}</h2>
                <hr>

                <div class="d-flex justify-content-between">
                    <span>Cash</span>
                    <strong style=" color: #374151;">₹{{ user.balance }}</strong>
                </div>
            </div>

            <div class="card mt-3 p-3 d-flex justify-content-between flex-row align-items-center" id="transactions" onclick="showTransaction()">
                <span>All transactions</span>
                <i class="bi bi-chevron-right"></i>
            </div>
        </div>

        <!-- RIGHT -->
        <div class="col-md-5">
            <div class="card p-4">
                <div class="d-flex justify-content-between funds-tabs">
                    <span id="addTab" class="fund-tab active" onclick="switchTab('add')" style="cursor: pointer;">
                        Add money
                    </span>
                    <span id="withdrawTab" class="fund-tab" onclick="switchTab('withdraw')" style="cursor: pointer;">
                        Withdraw
                    </span>

                </div>
                <hr>
                <input 
  id="amountInput"
  type="number"
  class="form-control text-center fs-1 fw-bold border-0"
  value="0"
  min="0"
  style="color:#374151; box-shadow:none;"
>
<div class="d-flex justify-content-center gap-3 my-4">
  <button class="btn btn-light rounded-pill" onclick="addAmount(1000)">
    +₹1,000
  </button>
  <button class="btn btn-light rounded-pill" onclick="addAmount(5000)">
    +₹5,000
  </button>
  <button class="btn btn-light rounded-pill" onclick="addAmount(10000)">
    +₹10,000
  </button>
</div>



                <div id="infoBox" class="alert alert-light text-center" style="padding:10px;">
                    Enter amount to add
                </div>
                <button id="actionBtn" class="btn w-100 mt-4" style="background-color:#04b488; color:white;">
                    Add money
                </button>
            </div>
        </div>

    </div>
</div>
<!-- Transactions Modal -->
<div class="modal fade" id="transactionsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title mb-0">Transactions</h5>
                    <div class="text-muted small">Recent activity for your account</div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div id="transactionsError" class="alert alert-danger d-none" role="alert"></div>
                <div id="transactionsLoading" class="d-flex align-items-center gap-2 text-muted">
                    <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
                    <span>Loading transactions…</span>
                </div>

                <div class="table-responsive mt-3">
                    <table class="table table-hover align-middle txn-table mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 160px;">Date</th>
                                <th style="width: 140px;">Type</th>
                                <th>Asset</th>
                                <th class="text-end" style="width: 180px;">Amount</th>
                                <th class="text-center" style="width: 120px;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="transactionBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block js %}
<script>
    var currentTab = "add";
  function switchTab(type) {
    const addTab = document.getElementById("addTab");
    const withdrawTab = document.getElementById("withdrawTab");
    const actionBtn = document.getElementById("actionBtn");
    const infoBox = document.getElementById("infoBox");
    const amountInput = document.getElementById("amountInput");

    if (type === "add") {
      addTab.classList.add("active");
      withdrawTab.classList.remove("active");

      actionBtn.innerText = "Add money";
      actionBtn.style.backgroundColor = "#04b488";
      infoBox.innerText = "Enter amount to add";
      currentTab = "add";
    } 
    else {
      withdrawTab.classList.add("active");
      addTab.classList.remove("active");

      actionBtn.innerText = "Withdraw";
      actionBtn.style.backgroundColor = "#04b488";

      infoBox.innerText = "No balance available to withdraw";
      amountInput.value = 0;
    currentTab = "withdraw";
    }
  }

  function addAmount(value) {
    const amountInput = document.getElementById("amountInput");
    let current = parseInt(amountInput.value || 0);
    amountInput.value = current + value;
  }

    document.getElementById("actionBtn").addEventListener("click", function() {
        const amountInput = document.getElementById("amountInput");
        let amount = parseInt(amountInput.value || 0);
    
        if (amount <= 0) {
        alert("Please enter a valid amount greater than 0.");
        return;
        }
    
        if (currentTab === "add") {
        // Redirect to add funds route
        window.location.href = `/login/add_funds?amount=${amount}`;
        } else {
        // Redirect to withdraw funds route
        window.location.href = `/login/withdraw_funds?amount=${amount}`;
        }
    });


        function formatINR(value) {
            const number = Number(value || 0);
            try {
                return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 2 }).format(number);
            } catch (e) {
                return `₹${number}`;
            }
        }

        function formatDateTime(value) {
            if (!value) return '-';
            const normalized = String(value).includes('T') ? String(value) : String(value).replace(' ', 'T');
            const dt = new Date(normalized);
            if (Number.isNaN(dt.getTime())) return String(value);
            return dt.toLocaleString('en-IN', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function txTypeMeta(type) {
            const t = String(type || '').toLowerCase();
            if (t.includes('add')) return { badge: 'text-bg-success', sign: '+' };
            if (t.includes('with')) return { badge: 'text-bg-warning', sign: '−' };
            if (t.includes('sell')) return { badge: 'text-bg-dark', sign: '+' };
            if (t.includes('buy')) return { badge: 'text-bg-primary', sign: '−' };
            return { badge: 'text-bg-secondary', sign: '' };
        }

        async function showTransaction() {
            const modalEl = document.getElementById('transactionsModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();

            const tbody = document.getElementById('transactionBody');
            const loading = document.getElementById('transactionsLoading');
            const errorBox = document.getElementById('transactionsError');

            tbody.innerHTML = '';
            errorBox.classList.add('d-none');
            errorBox.innerText = '';
            loading.classList.remove('d-none');

            try {
                const response = await fetch('/transactions/', { headers: { 'Accept': 'application/json' } });
                const data = await response.json();
                if (!response.ok) throw new Error((data && data.error) ? data.error : 'Failed to load transactions');

                const list = (data && data.transactions) ? data.transactions : [];
                if (!list.length) {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">No transactions yet</td></tr>`;
                    return;
                }

                tbody.innerHTML = list.map(tx => {
                    const asset = tx.symbol_name ? String(tx.symbol_name) : 'Wallet';
                    const meta = txTypeMeta(tx.transaction_type);
                    const typeLabel = String(tx.transaction_type || '—').toUpperCase();
                    const amount = `${meta.sign}${formatINR(tx.amount)}`;

                    return `
                        <tr>
                            <td class="text-muted" style="font-size: 0.9rem;">${formatDateTime(tx.created_at)}</td>
                            <td><span class="badge rounded-pill ${meta.badge} txn-badge">${typeLabel}</span></td>
                            <td><span class="badge bg-light text-dark border">${asset}</span></td>
                            <td class="text-end fw-bold" style="color:#374151;">${amount}</td>
                            <td class="text-center">
                                <span class="badge rounded-pill bg-success-subtle text-success border border-success">Success</span>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                errorBox.innerText = err && err.message ? err.message : 'Something went wrong';
                errorBox.classList.remove('d-none');
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">Unable to load transactions</td></tr>`;
            } finally {
                loading.classList.add('d-none');
            }
        }
</script>
{% endblock %}
