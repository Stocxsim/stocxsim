<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="/static/css/stock.css">
</head>

<body>

    <div class="container">
        <div class="left-panel">
            <div class="header-top">
                <div class="stock-logo">{{ stock.stock_name[0] }}</div>
                <div class="action-buttons">
                    <button><i class="bi bi-bookmark"></i> Watchlist</button>
                </div>
            </div>

            <div class="price-section">
                <h1 id="stockName">{{ stock.stock_name }}</h1>
                <div class="price-row">
                    <span class="current_price" id="currentPrice">‚Çπ--</span>
                    <span class="price_change" id="priceChange">--</span>
                </div>
            </div>

            <div class="chart-placeholder">
                Graph Space (Interactive Chart Area)
            </div>

            <div class="time-filters">
                <button>NSE</button>
                <button style="background: #eee;">1D</button>
                <button>1W</button>
                <button>1M</button>
                <button>3M</button>
                <button>1Y</button>
                <button>All</button>
            </div>
        </div>

        <div class="right-panel">
            <div class="order-header">
                <h2 id="orderStockName">{{ stock.stock_name }}</h2>
                <p class="exchange-info" id="exchange-id"></p>
            </div>

            <div class="tabs">
                <div class="tab active" id="buy-tab">BUY</div>
                <div class="tab" id="sell-tab">SELL</div>
            </div>

            <div class="order-type-chips">
                <div class="chip active">Delivery</div>
                <div class="chip">MTF 2.86x</div>
            </div>

            <div class="input-group">
                <label>Qty <b>BSE</b> ‚ñæ</label>
                <input id="qty" type="number" value="1">
            </div>

            <div class="input-group">
                <label id="priceTypeToggle" style="cursor:pointer;">Price <b id="orderTypeText">Limit</b> ‚ñæ</label>
                <input id="price" type="text">
            </div>

            <div class="footer-info">
                <div class="info-row">
                    <span>Balance: ‚Çπ0</span>
                    <span>Approx req.: ‚Çπ0</span>
                </div>
                <button class="buy-btn" id="submitOrderBtn">Buy</button>
            </div>
        </div>
    </div>

    <div class="gauge-container">
        <div class="gauge-title">Technical Indicator (RSI)</div>
        <svg class="gauge-svg" viewBox="0 0 320 180" preserveAspectRatio="xMidYMid meet">
            <!-- Gradient definitions for smooth color zones -->
            <defs>
                <linearGradient id="arcGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#c0392b;stop-opacity:1" />
                    <stop offset="20%" style="stop-color:#e74c3c;stop-opacity:1" />
                    <stop offset="40%" style="stop-color:#f39c12;stop-opacity:1" />
                    <stop offset="50%" style="stop-color:#7f8c8d;stop-opacity:1" />
                    <stop offset="60%" style="stop-color:#27ae60;stop-opacity:1" />
                    <stop offset="80%" style="stop-color:#2ecc71;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#16a085;stop-opacity:1" />
                </linearGradient>
            </defs>

            <!-- Semi-circular arc (180¬∞ from 180¬∞ to 0¬∞) -->
            <path class="gauge-arc" d="M 20 160 A 140 140 0 0 1 300 160" fill="none" stroke="url(#arcGradient)"
                stroke-width="3" stroke-linecap="round" />

            <!-- Needle group (rotates around center) -->
            <g class="needle-group">
                <!-- Needle line -->
                <line class="needle-line" x1="160" y1="160" x2="160" y2="40" stroke="black" stroke-width="2"
                    stroke-linecap="round" />

                <!-- Center dot -->
                <circle class="center-dot" cx="160" cy="160" r="5" fill="black" />
            </g>
        </svg>

        <div class="label-container">
            <div class="label-text" id="label">Neutral</div>
        </div>
    </div>

    <script>
        const STOCK_RSI = "{{ stock.rsi if stock.rsi else 50 }}";
        console.log("{{stock.rsi}}")

        setGauge()
        /**
         * Sets the gauge to a specific value with smooth animation.
         * @param {number} value - Range from -100 to +100
         */
        function setGauge(value) {
            // Clamp value to range [-100, 100]
            value = Math.max(-100, Math.min(100, value));

            // Convert linear value to rotation angle
            // -100 ‚Üí -90¬∞, 0 ‚Üí 0¬∞, +100 ‚Üí +90¬∞
            const angle = (value / 100) * 90;

            // Apply rotation to needle group
            const needleGroup = document.querySelector('.needle-group');
            needleGroup.style.transform = `rotate(${angle}deg)`;
            needleGroup.style.transformOrigin = '160px 160px';

            // Update label text and color based on value
            updateLabel(value);
        }

        /**
         * Updates the label text and color based on gauge value.
         * @param {number} value - Range from -100 to +100
         */
        function updateLabel(value) {
            const label = document.getElementById('label');
            let text, colorClass;

            rsi = (value / 2) + 50

            if (rsi <= 30) {
                text = 'Over Sold';
                colorClass = 'color-strong-sell';
            } else if (rsi <= 45) {
                text = 'Weak But Improving';
                colorClass = 'color-sell';
            } else if (rsi <= 55) {
                text = 'Neutral';
                colorClass = 'color-neutral';
            } else if (rsi <= 65) {
                text = 'Strong';
                colorClass = 'color-buy';
            } else {
                text = 'Over Baught';
                colorClass = 'color-strong-buy';
            }

            label.textContent = text;
            label.className = `label-text ${colorClass}`;
        }

        // Initialize gauge with RSI data (RSI: 0-100, convert to -100 to +100 scale)
        // RSI < 30 = Oversold (Sell), RSI > 70 = Overbought (Buy), RSI 30-70 = Neutral
        const rsiValue = parseFloat(STOCK_RSI);
        const gaugeValue = (rsiValue - 50) * 2; // Convert 0-100 to -100 to +100
        setGauge(gaugeValue);
    </script>

    <script>
        const STOCK_TOKEN = "{{ stock.stock_token }}";
        const STOCK_NAME = "{{ stock.stock_name }}";
    </script>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const socket = io();

        socket.on("connect", () => {
            console.log("‚úÖ Socket connected:", socket.id);
        });

        socket.on("disconnect", () => {
            console.log("‚ùå Socket disconnected");
        });

        socket.on("live_prices", (data) => {
            // 1Ô∏è‚É£ STOCK PAGE UPDATE
            if (data.stocks && data.stocks[STOCK_TOKEN]) {
                updateStockUI(data.stocks[STOCK_TOKEN]);
            }

            // 2Ô∏è‚É£ INDEX PAGE (future / optional)
            // Example:
            // updateIndexUI("26009", data.index["26009"]);
        });

        function updateStockUI(stock) {
            const priceEl = document.getElementById("currentPrice");
            const changeEl = document.getElementById("priceChange");
            const exchangeId = document.getElementById("exchange-id");

            if (!priceEl || !changeEl || !exchangeId) return;

            const isUp = stock.change >= 0;
            const sign = isUp ? "+" : "";
            window.lastLTP = stock.ltp;


            // üîπ Price
            priceEl.innerText = "‚Çπ" + stock.ltp.toFixed(2);

            // üîπ Change line
            changeEl.innerText = `${sign}${stock.change.toFixed(2)} (${stock.percent_change.toFixed(2)}%)`;
            changeEl.className =
                "price-change " + (isUp ? "text-success" : "text-danger");

            // üîπ Exchange row
            exchangeId.innerHTML = `
                    <span class="fw-semibold">
                    ‚Çπ${stock.ltp.toFixed(2)}
                    </span>
                    <span class="mx-1 text-muted">‚Ä¢</span>
                    <span class="${isUp ? 'text-success' : 'text-danger'}">
                    (${sign}${stock.percent_change.toFixed(2)}%)
                    </span>
                `;
            if (orderType === "limit") {
                priceInput.value = stock.ltp.toFixed(2);
            }

        }
        // =========================
        // GLOBAL STATE
        // =========================
        let transactionType = "buy";     // buy | sell
        let orderType = "limit";         // limit | market

        const buyTab = document.getElementById("buy-tab");
        const sellTab = document.getElementById("sell-tab");
        const submitBtn = document.getElementById("submitOrderBtn");

        // =========================
        // BUY TAB
        // =========================
        buyTab.addEventListener("click", () => {
            transactionType = "buy";

            buyTab.classList.add("active");
            sellTab.classList.remove("active", "sell-active");

            submitBtn.innerText = "Buy";
            submitBtn.classList.remove("sell-btn");
            submitBtn.classList.add("buy-btn");
        });

        // =========================
        // SELL TAB
        // =========================
        sellTab.addEventListener("click", () => {
            transactionType = "sell";

            sellTab.classList.add("active", "sell-active");
            buyTab.classList.remove("active");

            submitBtn.innerText = "Sell";
            submitBtn.classList.remove("buy-btn");
            submitBtn.classList.add("sell-btn");
        });

        // =========================
        // SUBMIT ORDER
        // =========================
        submitBtn.addEventListener("click", function () {

            // üîê Snapshot (race condition avoid)
            const currentTransactionType = transactionType;
            const currentOrderType = orderType;

            const qtyValue = document.getElementById("qty").value.trim();
            const priceValue = document.getElementById("price").value.trim();

            // =========================
            // VALIDATION
            // =========================
            if (!qtyValue || isNaN(qtyValue) || Number(qtyValue) <= 0) {
                alert("‚ùå Valid quantity aapo");
                return;
            }

            if (currentOrderType === "limit") {
                if (!priceValue || isNaN(priceValue) || Number(priceValue) <= 0) {
                    alert("‚ùå Valid price aapo");
                    return;
                }
            }

            const payload = {
                symbol_token: STOCK_TOKEN,
                quantity: Number(qtyValue),                 // number j jaay
                order_type: currentOrderType,
                price: currentOrderType === "market" ? "" : priceValue,
                transaction_type: currentTransactionType
            };

            fetch("/trade/order", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams(payload)
            })
                .then(res => res.json())
                .then(data => {
                    console.log("ORDER RESPONSE:", data);

                    if (data.error) {
                        alert("‚ùå " + data.error);
                    } else {
                        alert("‚úÖ " + data.message);

                        // optional reset
                        document.getElementById("qty").value = "";

                    }
                })
                .catch(err => {
                    console.error("Order error:", err);
                    alert("‚ö†Ô∏è Something went wrong!");
                });
        });
        const priceInput = document.getElementById("price");
        const orderTypeText = document.getElementById("orderTypeText");
        const priceToggle = document.getElementById("priceTypeToggle");

        priceToggle.addEventListener("click", () => {
            if (orderType === "limit") {
                // üëâ LIMIT ‚Üí MARKET
                orderType = "market";
                orderTypeText.innerText = "Market";

                priceInput.value = window.lastLTP.toFixed(2);
                priceInput.disabled = true;
            } else {
                // üëâ MARKET ‚Üí LIMIT
                orderType = "limit";
                orderTypeText.innerText = "Limit";

                priceInput.disabled = false;

                // current price muki do
                priceInput.value = window.lastLTP.toFixed(2);
            }
        });

    </script>

</body>

</html>